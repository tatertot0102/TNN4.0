---
const { initialTheme = "light" } = Astro.props;
const isDark = initialTheme === "dark";
---

<header
  id="site-header"
  data-theme={initialTheme}
  class="sticky top-0 z-50 transition-colors duration-200 bg-black text-white"
>
  <div class="mx-auto w-full max-w-[1440px]">
    <!-- Top utility bar -->
    <div class="flex items-center justify-between px-4 sm:px-8 lg:px-12 py-3 border-b border-white/10">
      <!-- Logo centered -->
      <div class="flex-1"></div>
      <a href="/" class="text-center" aria-label="TNN Home">
        <div class="flex items-center justify-center gap-2">
          <span class="text-2xl sm:text-3xl font-semibold tracking-tight">TNN</span>
          <span class="text-sm text-red-500 font-bold">100</span>
        </div>
        <div class="text-[9px] uppercase tracking-[0.3em] opacity-70 mt-0.5">
          Tech News Network
        </div>
      </a>

      <!-- Right utility links -->
      <div class="flex-1 flex items-center justify-end gap-4">
        <a class="hidden sm:block text-sm hover:opacity-70 transition-opacity" href="/newsletter">Newsletter</a>
        <a class="hidden sm:block text-sm hover:opacity-70 transition-opacity" href="/signin">Sign In</a>
        <button class="bg-[#1b2a6b] text-white px-4 py-1.5 text-sm font-medium hover:bg-[#142152] transition-colors rounded">
          Subscribe
        </button>
        <button class="hover:opacity-70 transition-opacity" aria-label="Search">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Bottom Navigation Bar (this is the "dock" that should hide on scroll down, show on scroll up,
         and COMPLETELY DISABLE after you pass Today's Mix) -->
    <div id="dock-wrap" class="dockWrap">
      <nav id="dock-nav" class="dock px-4 sm:px-8 lg:px-12">
        <ul class="flex items-center justify-center gap-6 sm:gap-8 text-sm flex-wrap">
          <li><a class="hover:opacity-70 transition-opacity font-medium section-link" href="#hardnews" data-section="hardnews">Hard News</a></li>
          <li><a class="hover:opacity-70 transition-opacity font-medium section-link" href="#features" data-section="features">Features</a></li>
          <li><a class="hover:opacity-70 transition-opacity font-medium section-link" href="#breaking" data-section="breaking">Breaking</a></li>
          <li><a class="hover:opacity-70 transition-opacity font-medium section-link" href="#docs" data-section="docs">Docs</a></li>
          <li><a class="hover:opacity-70 transition-opacity font-medium section-link" href="#opinion" data-section="opinion">Opinion</a></li>
          <li><a class="hover:opacity-70 transition-opacity font-medium section-link" href="#heartwarming" data-section="heartwarming">Heartwarming</a></li>
          <li><a class="hover:opacity-70 transition-opacity font-medium section-link" href="#promo" data-section="promo">Promo</a></li>
        </ul>
      </nav>
    </div>
  </div>
</header>

<style>
  html { scroll-behavior: smooth; }

  /* Remove bottom shadow from header */
  #site-header { 
    box-shadow: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  /* Dock animation: "collapse upwards" (apply to WRAP so border/padding also collapse) */
  .dockWrap {
    overflow: hidden;
    border-top: 1px solid rgba(255,255,255,0.10);
    max-height: 140px;
    opacity: 1;
    transform: translateY(0);
    transition:
      transform 220ms cubic-bezier(.2,.8,.2,1),
      opacity 200ms ease,
      max-height 220ms cubic-bezier(.2,.8,.2,1);
    will-change: transform, opacity, max-height;
    background: rgba(0,0,0,0.92);
  }

  /* Give the nav its vertical padding so we can collapse it by collapsing the wrapper */
  .dock {
    padding-top: 0.75rem; /* ~py-3 */
    padding-bottom: 0.75rem;
  }

  /* Hidden (scrolling down): slides up + collapses */
  .dockWrap.is-hidden {
    transform: translateY(-100%);
    opacity: 0;
    max-height: 0;
    border-top-color: transparent;
  }

  /* Disabled (after Today's Mix): fully off */
  .dockWrap.is-disabled {
    transform: translateY(-100%);
    opacity: 0;
    max-height: 0;
    border-top-color: transparent;
    pointer-events: none;
  }

  /* Ensure dock links read correctly on dark */
  #dock-nav a { color: rgba(255,255,255,0.92); }
  #dock-nav a:hover { opacity: 0.75; }

  @media (prefers-reduced-motion: reduce) {
    .dockWrap { transition: none; }
  }
</style>

<script is:inline>
  (() => {
    const dockWrap = document.getElementById("dock-wrap");
    const dock = document.getElementById("dock-nav");
    if (!dockWrap || !dock) return;

    // Section navigation functionality
    const sectionLinks = document.querySelectorAll('.section-link');
    sectionLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.dataset.section;
        
        // First, scroll to the sticky tabs area
        const tabsElement = document.getElementById('section-tabs');
        if (tabsElement) {
          tabsElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          
          // Wait for scroll to complete, then activate the tab
          setTimeout(() => {
            const targetTab = document.querySelector(`[data-tab="${sectionId}"]`);
            if (targetTab) {
              targetTab.click();
            }
          }, 500);
        }
      });
    });

    // Collapsing dock functionality
    let sentinel = document.querySelector("[data-mix-sentinel]");
    const mix = document.getElementById("todays-mix");

    let heroSentinel = document.querySelector("[data-hero-sentinel]");
    const hero =
      document.getElementById("top-story") ||
      document.getElementById("hero") ||
      document.querySelector("[data-hero]") ||
      document.querySelector("main > section") ||
      null;

    if (!heroSentinel && hero) {
      heroSentinel = document.createElement("div");
      heroSentinel.setAttribute("data-hero-sentinel", "");
      heroSentinel.style.height = "1px";
      heroSentinel.style.width = "1px";
      heroSentinel.style.pointerEvents = "none";
      hero.insertAdjacentElement("afterend", heroSentinel);
    }

    let allowCollapse = !heroSentinel;

    let enabled = true;
    let shown = true;
    let lastY = window.scrollY || 0;
    let lastCollapseGateY = window.scrollY || 0;

    const setDock = ({ enable, show }) => {
      enabled = enable;
      shown = show;

      dockWrap.classList.toggle("is-disabled", !enabled);
      dockWrap.classList.toggle("is-hidden", enabled && !shown);
    };

    const hasSentinel = !!sentinel;

    if (heroSentinel) {
      const heroIO = new IntersectionObserver((entries) => {
        const entry = entries[0];
        const pastHero = !entry.isIntersecting && entry.boundingClientRect.top < 0;
        allowCollapse = pastHero;

        if (!allowCollapse) {
          lastToggleY = window.scrollY || 0;
          lastCollapseGateY = window.scrollY || 0;
          setDock({ enable: true, show: true });
        }
      }, { threshold: 0 });

      heroIO.observe(heroSentinel);
    }

    if (hasSentinel) {
      const io = new IntersectionObserver((entries) => {
        const entry = entries[0];

        const pastMix = !entry.isIntersecting && entry.boundingClientRect.top < 0;
        const active = !pastMix;

        setDock({ enable: active, show: active ? true : false });
        if (active) {
          lastToggleY = window.scrollY || 0;
          lastCollapseGateY = window.scrollY || 0;
        }
      }, { threshold: 0 });

      io.observe(sentinel);
    }

    const HIDE_AFTER_PX = 90;
    const SHOW_AFTER_PX = 50;

    let lastToggleY = window.scrollY || 0;

    const onScroll = () => {
      const y = window.scrollY || 0;
      const delta = y - lastY;
      lastY = y;

      if (hasSentinel && !enabled) return;

      if (y <= 8) {
        lastToggleY = y;
        setDock({ enable: true, show: true });
        return;
      }

      if (!allowCollapse) return;

      if (delta > 0) {
        const base = Math.max(lastToggleY, lastCollapseGateY);
        if (shown && (y - base) >= HIDE_AFTER_PX) {
          lastToggleY = y;
          setDock({ enable: true, show: false });
        }
        return;
      }

      if (delta < 0) {
        if (!shown && (lastToggleY - y) >= SHOW_AFTER_PX) {
          lastToggleY = y;
          setDock({ enable: true, show: true });
        }
      }
    };

    window.addEventListener("scroll", onScroll, { passive: true });
  })();
</script>